import telebot
from telebot import types
import random
import time

TOKEN = "7883073332:AAEJAmuOvpSvKi4qp-P9wClytu59RE7JT70"
DEVELOPER = "PXU_12"
bot = telebot.TeleBot(TOKEN)

# ğŸ”¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆÙ„ÙŠØª
roulettes = {}
chat_locked = {}
muted_users = {}
banned_users = {}
global_banned_messages = set()

# ===== Ø­Ù…Ø§ÙŠØ© Ù…Ù† ØªÙˆÙ‚Ù Ø§Ù„Ø¨ÙˆØª =====
def safe_handler(func):
    def wrapper(message):
        try:
            func(message)
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‡Ø§Ù†Ø¯Ù„Ø±: {e}")
    return wrapper

# ===== Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±ÙˆÙ„ÙŠØª =====
@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("Ø±ÙˆÙ„ÙŠØª"))
@safe_handler
def start_roulette(message):
    chat_id = message.chat.id
    user_id = message.from_user.id

    # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ Ø±ÙˆÙ„ÙŠØª Ø´ØºØ§Ù„
    if chat_id in roulettes:
        bot.reply_to(message, "âš ï¸ ÙŠÙˆØ¬Ø¯ Ø±ÙˆÙ„ÙŠØª Ø´ØºØ§Ù„. Ø§Ø±Ø³Ù„ 'Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ„ÙŠØª' Ù„Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯.")
        return

    # ØªØ­Ù‚Ù‚ Ù…Ø´Ø±Ù
    member = bot.get_chat_member(chat_id, user_id)
    if member.status not in ["administrator", "creator"]:
        bot.reply_to(message, "âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ ÙŠÙ‚Ø¯Ø±ÙˆÙ† ÙŠØ³ÙˆÙˆÙ† Ø±ÙˆÙ„ÙŠØª.")
        return

    try:
        num_winners = int(message.text.split()[1])
    except:
        bot.reply_to(message, "âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ ÙƒÙ„Ù…Ø© Ø±ÙˆÙ„ÙŠØª.")
        return

    # ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
    roulette = {
        "owner": user_id,
        "players": [],
        "num_winners": num_winners,
        "msg_id": None
    }

    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ù…Ø´Ø§Ø±ÙƒØ©", callback_data=f"join_{chat_id}"))
    markup.add(types.InlineKeyboardButton("Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©", callback_data=f"start_{chat_id}"))

    text = f"""â€¢ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±ÙˆÙ„ÙŠØª ğŸ‘‘

- ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠÙ‡Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¶ØºØ· Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ©

â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† : 0
-"""
    msg = bot.send_message(chat_id, text, reply_markup=markup)
    roulette["msg_id"] = msg.message_id
    roulettes[chat_id] = roulette

# Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø©
@bot.callback_query_handler(func=lambda call: call.data.startswith("join_"))
def join_roulette(call):
    chat_id = int(call.data.split("_")[1])
    if chat_id not in roulettes:
        bot.answer_callback_query(call.id, "ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¹Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.", show_alert=True)
        return

    roulette = roulettes[chat_id]
    user_id = call.from_user.id

    if user_id in roulette["players"]:
        bot.answer_callback_query(call.id, "âœ… Ø§Ù†Øª Ù…Ø´Ø§Ø±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„.", show_alert=True)
        return

    roulette["players"].append(user_id)
    bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù†Ø¶Ù…Ø§Ù…Ùƒ Ù„Ù„Ø±ÙˆÙ„ÙŠØªâœ…", show_alert=True)

    text = f"""â€¢ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±ÙˆÙ„ÙŠØª ğŸ‘‘

- ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠÙ‡Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¶ØºØ· Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ©

â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† : {len(roulette['players'])}
-"""
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ù…Ø´Ø§Ø±ÙƒØ©", callback_data=f"join_{chat_id}"))
    markup.add(types.InlineKeyboardButton("Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©", callback_data=f"start_{chat_id}"))
    bot.edit_message_text(text, chat_id, roulette["msg_id"], reply_markup=markup)

# Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
@bot.callback_query_handler(func=lambda call: call.data.startswith("start_"))
def start_game(call):
    chat_id = int(call.data.split("_")[1])
    if chat_id not in roulettes: return

    roulette = roulettes[chat_id]
    user_id = call.from_user.id

    if user_id != roulette["owner"]:
        bot.answer_callback_query(call.id, "âŒ ÙÙ‚Ø· Ù…Ù† Ø£Ù†Ø´Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙŠÙ‚Ø¯Ø± ÙŠØ¨Ø¯Ø£Ù‡Ø§.", show_alert=True)
        return

    if len(roulette["players"]) < roulette["num_winners"]:
        bot.answer_callback_query(call.id, "âš ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø£Ù‚Ù„ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†.", show_alert=True)
        return

    winners = random.sample(roulette["players"], roulette["num_winners"])
    try:
        bot.delete_message(chat_id, roulette["msg_id"])
    except: pass

    text = "â€¢ Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±ÙˆÙ„ÙŠØª ğŸ¥³:\n\n"
    for i, w_id in enumerate(winners, 1):
        user = bot.get_chat_member(chat_id, w_id).user
        text += f"{i}- [{user.first_name}](tg://user?id={user.id})\n"

    bot.send_message(chat_id, text, parse_mode="Markdown")
    del roulettes[chat_id]

# Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ„ÙŠØª
@bot.message_handler(func=lambda m: m.text.lower() == "Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±ÙˆÙ„ÙŠØª")
@safe_handler
def end_roulette(message):
    chat_id = message.chat.id
    if chat_id in roulettes:
        try: bot.delete_message(chat_id, roulettes[chat_id]["msg_id"])
        except: pass
        del roulettes[chat_id]
        bot.reply_to(message, "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±ÙˆÙ„ÙŠØª âœ…")
    else:
        bot.reply_to(message, "ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¹Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")

# ===== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© =====
def restrict_user(chat_id, user_id, can_send=True):
    bot.restrict_chat_member(chat_id, user_id,
        can_send_messages=can_send,
        can_send_media_messages=can_send,
        can_send_other_messages=can_send,
        can_add_web_page_previews=can_send)

@bot.message_handler(func=lambda m: m.reply_to_message and m.text.lower() == "ÙƒØªÙ…")
@safe_handler
def mute_user(message):
    chat_id = message.chat.id
    if not is_admin(message): return
    user_id = message.reply_to_message.from_user.id
    if muted_users.get(user_id):
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù…ÙƒØªÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„.")
        return
    restrict_user(chat_id, user_id, can_send=False)
    muted_users[user_id] = True
    bot.reply_to(message, f"ğŸ”‡ ØªÙ… ÙƒØªÙ… {message.reply_to_message.from_user.first_name} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.")

@bot.message_handler(func=lambda m: m.reply_to_message and m.text.lower() == "Ø§Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…")
@safe_handler
def unmute_user(message):
    chat_id = message.chat.id
    if not is_admin(message): return
    user_id = message.reply_to_message.from_user.id
    if not muted_users.get(user_id):
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù„ÙŠØ³ Ù…ÙƒØªÙˆÙ….")
        return
    restrict_user(chat_id, user_id, can_send=True)
    del muted_users[user_id]
    bot.reply_to(message, f"âœ… ØªÙ… Ø§Ù„ØºØ§Ø¡ ÙƒØªÙ… {message.reply_to_message.from_user.first_name}.")

@bot.message_handler(func=lambda m: m.reply_to_message and m.text.lower() == "Ø­Ø¸Ø±")
@safe_handler
def ban_user(message):
    chat_id = message.chat.id
    if not is_admin(message): return
    user_id = message.reply_to_message.from_user.id
    if banned_users.get(user_id):
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø­Ø¸ÙˆØ± Ø¨Ø§Ù„ÙØ¹Ù„.")
        return
    bot.ban_chat_member(chat_id, user_id)
    banned_users[user_id] = True
    bot.reply_to(message, f"ğŸš« ØªÙ… Ø­Ø¸Ø± {message.reply_to_message.from_user.first_name}.")

@bot.message_handler(func=lambda m: m.reply_to_message and m.text.lower() == "Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±")
@safe_handler
def unban_user(message):
    chat_id = message.chat.id
    if not is_admin(message): return
    user_id = message.reply_to_message.from_user.id
    if not banned_users.get(user_id):
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø¹Ø¶Ùˆ Ù„ÙŠØ³ Ù…Ø­Ø¸ÙˆØ±.")
        return
    bot.unban_chat_member(chat_id, user_id)
    del banned_users[user_id]
    bot.reply_to(message, f"âœ… ØªÙ… Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø± {message.reply_to_message.from_user.first_name}.")

# ===== Ù‚ÙÙ„ ÙˆÙØªØ­ Ø§Ù„Ø´Ø§Øª =====
@bot.message_handler(func=lambda m: m.text.lower() == "Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Øª")
@safe_handler
def lock_chat(message):
    chat_id = message.chat.id
    if not is_admin(message): return
    if chat_locked.get(chat_id):
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø´Ø§Øª Ù…Ù‚ÙÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„.")
        return
    bot.set_chat_permissions(chat_id, types.ChatPermissions(can_send_messages=False))
    chat_locked[chat_id] = True
    bot.reply_to(message, "ğŸ”’ ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Øª.")

@bot.message_handler(func=lambda m: m.text.lower() == "ÙØªØ­ Ø§Ù„Ø´Ø§Øª")
@safe_handler
def unlock_chat(message):
    chat_id = message.chat.id
    if not is_admin(message): return
    if not chat_locked.get(chat_id):
        bot.reply_to(message, "âš ï¸ Ø§Ù„Ø´Ø§Øª Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„.")
        return
    bot.set_chat_permissions(chat_id, types.ChatPermissions(can_send_messages=True,
        can_send_media_messages=True, can_send_other_messages=True, can_add_web_page_previews=True))
    chat_locked[chat_id] = False
    bot.reply_to(message, "ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„Ø´Ø§Øª.")

# ===== Ù…Ù†Ø¹ Ø¹Ø§Ù… (Ù„Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·) =====
@bot.message_handler(func=lambda m: m.reply_to_message and m.text.lower() == "Ù…Ù†Ø¹ Ø¹Ø§Ù…")
@safe_handler
def global_ban(message):
    if message.from_user.username != DEVELOPER: return
    target = message.reply_to_message
    if target.text: global_banned_messages.add(target.text.strip())
    elif target.sticker: global_banned_messages.add(target.sticker.file_unique_id)
    bot.reply_to(message, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©/Ù…Ù„ØµÙ‚ Ù„Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø§Ù….")

@bot.message_handler(content_types=["text","sticker"])
@safe_handler
def filter_global(message):
    if message.text and message.text.strip() in global_banned_messages:
        bot.delete_message(message.chat.id, message.message_id)
        bot.send_message(message.chat.id, "ğŸš« ØªÙ… Ù…Ù†Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø·ÙˆØ±.")
    elif message.sticker and message.sticker.file_unique_id in global_banned_messages:
        bot.delete_message(message.chat.id, message.message_id)
        bot.send_message(message.chat.id, "ğŸš« ØªÙ… Ù…Ù†Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø·ÙˆØ±.")

# ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù =====
def is_admin(message):
    try:
        member = bot.get_chat_member(message.chat.id, message.from_user.id)
        return member.status in ["administrator", "creator"]
    except: return False

# ===== Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© + Ø­Ù…Ø§ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ =====
while True:
    try:
        print("ğŸš€ Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„...")
        bot.infinity_polling(timeout=60, long_polling_timeout=60)
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: {e}")
        time.sleep(5)
